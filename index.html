<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Speaking Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 80%;
            margin: 50px auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            text-align: center;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            background-color: #FFA500; /* Orange */
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #FF8C00; /* Darker Orange */
        }
        #feedback, #progress {
            margin-top: 20px;
        }
        #countdown {
            text-align: center;
            font-size: 18px;
            color: red;
            display: none;
        }
        #timer-icon, #mic-icon {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            margin-right: 5px;
        }
        #recording-icons {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
        #volume-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .volume-block {
            width: 10px;
            height: 20px;
            margin: 0 2px;
            background-color: #ddd;
            transition: background-color 0.1s;
        }
        #video-container {
            text-align: center;
            margin-top: 20px;
        }
        video {
            width: 80%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to the Speaking Test!</h1>
        <p>Press "Start" to begin.</p>
        <button onclick="startTest()">Start Test</button>
        
        <div id="test" style="display:none;">
            <h3 id="task-title">Task 1: Travel and Memories</h3>

            <!-- Video player for questions -->
            <div id="video-container">
                <video id="question-video" controls autoplay muted>
                    <source id="video-source" src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>

            <h2>Question:</h2>
            <p id="question">Say something about your favorite hobby.</p>

            <!-- Countdown timer before recording -->
            <button onclick="startCountdown()">Record Answer</button>
            <p id="countdown">
                <img id="timer-icon" src="https://img.icons8.com/ios-filled/50/000000/timer.png" alt="timer icon" />
                <span id="countdown-text">Recording starts in 5 seconds...</span>
            </p>

            <!-- Microphone and volume block bar during recording -->
            <div id="recording-icons">
                <img id="mic-icon" src="https://img.icons8.com/ios-filled/50/000000/microphone.png" alt="microphone icon" />
                <p>Recording... Speak now!</p>
                <div id="volume-container">
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                    <div class="volume-block"></div>
                </div>
            </div>

            <button onclick="submitAnswer()">Submit</button>
            <p id="feedback"></p>
        </div>

        <div id="progress" style="display:none;">
            <h2>Your Progress</h2>
            <p id="progressData">No attempts yet.</p>
            <button onclick="downloadProgress()">Download Progress</button>
        </div>
    </div>

    <script>
        let questionIndex = 0;
        let taskIndex = 1;
        
        const taskTitles = [
            "DCT 1",
            "DCT 2"
        ];

        const task1Questions = [
            "We should go somewhere to make memories. Do you have any suggestions for where to go?",
            "Do you know how to get there?",
            "When and how long is this holiday going to be?"
        ];
        
        const task2Questions = [
            "Describe a memorable event in your life.",
            "What is your favorite food and why do you like it?",
            "Tell me about a friend who inspires you."
        ];
        
        const questions = [...task1Questions, ...task2Questions];
        
        const videos = [
            "videos/task1_DCT 1 Q1.mp4",
            "videos/task1_DCT 1 Q2.mp4",
            "videos/task1_DCT 1 Q3.mp4",
            "videos/task2_question1.mp4",
            "videos/task2_question2.mp4",
            "videos/task2_question3.mp4"
        ];
        
        let answers = [];
        let recognition;
        let audioContext;
        let analyser;
        let microphone;
        let volumeBlocks;

        function startTest() {
            document.querySelector('button').style.display = 'none';
            document.getElementById('test').style.display = 'block';
            loadQuestion();
        }

        function loadQuestion() {
            if (questionIndex < questions.length) {
                if (questionIndex === task1Questions.length) {
                    document.getElementById('task-title').innerText = taskTitles[1];
                }
                document.getElementById('question').innerText = questions[questionIndex];
                loadVideo(questionIndex);
            } else {
                showProgress();
            }
        }

        // Load the correct video for the current question
        function loadVideo(index) {
            const videoElement = document.getElementById('question-video');
            const videoSource = document.getElementById('video-source');
            videoSource.src = videos[index];
            videoElement.load();
            videoElement.play();
        }

        // Countdown timer before recording
        function startCountdown() {
            let countdown = 5;
            document.getElementById('countdown').style.display = 'block';
            document.getElementById('countdown-text').innerText = `Recording starts in ${countdown} seconds...`;

            let interval = setInterval(() => {
                countdown--;
                document.getElementById('countdown-text').innerText = `Recording starts in ${countdown} seconds...`;

                if (countdown <= 0) {
                    clearInterval(interval);
                    document.getElementById('countdown').style.display = 'none';
                    startRecording();
                }
            }, 1000);
        }

        function startRecording() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            // Show microphone and volume blocks
            document.getElementById('recording-icons').style.display = 'block';
            volumeBlocks = document.querySelectorAll('.volume-block');

            startVolumeMeter();

            recognition.start();

            recognition.onresult = function(event) {
                let transcript = event.results[0][0].transcript;
                answers.push(transcript);
                document.getElementById('feedback').innerText = getFeedback(transcript);
                
                // Hide icons after recording is complete
                document.getElementById('recording-icons').style.display = 'none';
                stopVolumeMeter();
                questionIndex++;
                setTimeout(loadQuestion, 2000);
            };

            recognition.onerror = function(event) {
                alert('Error occurred while recording. Please try again.');
                document.getElementById('recording-icons').style.display = 'none';
                stopVolumeMeter();
            };
        }

        // Volume meter functionality with blocks
        function startVolumeMeter() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                microphone.connect(analyser);
                analyser.fftSize = 256;

                let dataArray = new Uint8Array(analyser.frequencyBinCount);

                function updateVolume() {
                    analyser.getByteFrequencyData(dataArray);
                    let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    let volumeLevel = Math.min(10, Math.floor((volume / 255) * 10));
                    
                    volumeBlocks.forEach((block, index) => {
                        if (index < volumeLevel) {
                            if (volumeLevel <= 3) {
                                block.style.backgroundColor = 'red';
                            } else if (volumeLevel <= 6) {
                                block.style.backgroundColor = 'yellow';
                            } else {
                                block.style.backgroundColor = 'green';
                            }
                        } else {
                            block.style.backgroundColor = '#ddd';
                        }
                    });
                    requestAnimationFrame(updateVolume);
                }

                updateVolume();
            });
        }

        function stopVolumeMeter() {
            if (microphone) {
                microphone.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
        }

        function getFeedback(transcript) {
            if (transcript.length > 10) {
                return "Good job! Try to add more details in your next response.";
            } else {
                return "Try to give a longer and clearer response.";
            }
        }

        function submitAnswer() {
            document.getElementById('feedback').innerText = "Processing answer...";
        }

        function showProgress() {
            document.getElementById('test').style.display = 'none';
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressData').innerText = `You answered ${answers.length} questions. Keep practicing!`;
        }

        // Download progress as text file
        function downloadProgress() {
            let progressData = "Your Speaking Test Progress:\n\n";
            answers.forEach((answer, index) => {
                let taskName = index < task1Questions.length ? taskTitles[0] : taskTitles[1];
                progressData += `${taskName}\nQ${index + 1}: ${questions[index]}\nAnswer: ${answer}\n\n`;
            });

            const blob = new Blob([progressData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'progress_report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
